name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-15
    env:
      APP_TARGET: ContextBriefApp
      APP_BUNDLE_NAME: ContextBrief
      APP_EXECUTABLE_NAME: ContextBrief
      APP_PATH: .build/release/ContextBrief.app
      DMG_PATH: .build/release/ContextBrief.dmg
      HOMEBREW_TAP_REPO_TOKEN: ${{ secrets.HOMEBREW_TAP_REPO_TOKEN }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
      DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
      APPSTORE_CONNECT_KEY_ID: ${{ secrets.APPSTORE_CONNECT_KEY_ID }}
      APPSTORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
      APPSTORE_CONNECT_API_KEY_BASE64: ${{ secrets.APPSTORE_CONNECT_API_KEY_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release version
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "build_number=${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Validate notarization secrets
        run: |
          test -n "${APPLE_TEAM_ID}" || { echo "Missing APPLE_TEAM_ID secret"; exit 1; }
          test -n "${DEVELOPER_ID_CERT_BASE64}" || { echo "Missing DEVELOPER_ID_CERT_BASE64 secret"; exit 1; }
          test -n "${DEVELOPER_ID_CERT_PASSWORD}" || { echo "Missing DEVELOPER_ID_CERT_PASSWORD secret"; exit 1; }
          test -n "${APPSTORE_CONNECT_KEY_ID}" || { echo "Missing APPSTORE_CONNECT_KEY_ID secret"; exit 1; }
          test -n "${APPSTORE_CONNECT_ISSUER_ID}" || { echo "Missing APPSTORE_CONNECT_ISSUER_ID secret"; exit 1; }
          test -n "${APPSTORE_CONNECT_API_KEY_BASE64}" || { echo "Missing APPSTORE_CONNECT_API_KEY_BASE64 secret"; exit 1; }
          test -n "${KEYCHAIN_PASSWORD}" || { echo "Missing KEYCHAIN_PASSWORD secret"; exit 1; }

      - name: Install signing certificate and notary key
        run: |
          CERT_PATH="${RUNNER_TEMP}/developer_id_app.p12"
          KEYCHAIN_PATH="${RUNNER_TEMP}/build.keychain-db"
          API_KEY_PATH="${RUNNER_TEMP}/AuthKey_${APPSTORE_CONNECT_KEY_ID}.p8"

          echo "${DEVELOPER_ID_CERT_BASE64}" | base64 --decode > "${CERT_PATH}"
          echo "${APPSTORE_CONNECT_API_KEY_BASE64}" | base64 --decode > "${API_KEY_PATH}"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" -P "${DEVELOPER_ID_CERT_PASSWORD}" -A -t cert -f pkcs12 -k "${KEYCHAIN_PATH}"
          security list-keychains -d user -s "${KEYCHAIN_PATH}" login.keychain-db
          security default-keychain -d user -s "${KEYCHAIN_PATH}"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"

      - name: Build app bundle
        run: |
          make release-app \
            VERSION="${{ steps.version.outputs.version }}" \
            BUILD_NUMBER="${{ steps.version.outputs.build_number }}"

      - name: Sign app bundle
        run: |
          IDENTITY="$(security find-identity -v -p codesigning | awk -F\" '/Developer ID Application: .* \('"${APPLE_TEAM_ID}"'\)/ {print $2; exit}')"
          test -n "${IDENTITY}" || { echo "Developer ID Application identity not found for team ${APPLE_TEAM_ID}"; exit 1; }
          echo "Using signing identity: ${IDENTITY}"

          if [ -d "${APP_PATH}/Contents/Frameworks" ]; then
            find "${APP_PATH}/Contents/Frameworks" \( -name "*.framework" -o -name "*.dylib" \) -print0 \
              | while IFS= read -r -d '' item; do
                  codesign --force --sign "${IDENTITY}" --timestamp "${item}"
                done
          fi

          if [ -d "${APP_PATH}/Contents/MacOS" ]; then
            find "${APP_PATH}/Contents/MacOS" -type f -perm -111 -print0 \
              | while IFS= read -r -d '' item; do
                  codesign --force --sign "${IDENTITY}" --timestamp "${item}"
                done
          fi

          codesign --force --sign "${IDENTITY}" --timestamp --options runtime "${APP_PATH}"
          codesign --verify --deep --strict --verbose=2 "${APP_PATH}"

      - name: Build signed DMG
        run: |
          bash ./scripts/build_dmg.sh "${APP_PATH}" "${DMG_PATH}"

      - name: Sign, notarize, and staple DMG
        run: |
          IDENTITY="$(security find-identity -v -p codesigning | awk -F\" '/Developer ID Application: .* \('"${APPLE_TEAM_ID}"'\)/ {print $2; exit}')"
          API_KEY_PATH="${RUNNER_TEMP}/AuthKey_${APPSTORE_CONNECT_KEY_ID}.p8"

          codesign --force --sign "${IDENTITY}" --timestamp "${DMG_PATH}"
          codesign --verify --verbose=2 "${DMG_PATH}"

          xcrun notarytool submit "${DMG_PATH}" \
            --key "${API_KEY_PATH}" \
            --key-id "${APPSTORE_CONNECT_KEY_ID}" \
            --issuer "${APPSTORE_CONNECT_ISSUER_ID}" \
            --wait

          xcrun stapler staple "${DMG_PATH}"
          xcrun stapler validate "${DMG_PATH}"

      - name: Compute DMG SHA256
        id: sha
        run: |
          echo "sha256=$(shasum -a 256 "${DMG_PATH}" | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: Context Brief ${{ steps.version.outputs.tag }}
          tag_name: ${{ steps.version.outputs.tag }}
          files: ${{ env.DMG_PATH }}
          generate_release_notes: true
          body: |
            ## Installation

            1. Download `ContextBrief.dmg` from assets below.
            2. Open the DMG and drag `ContextBrief.app` into `/Applications`.
            3. Launch `ContextBrief`.

            Or install with Homebrew:

            ```bash
            brew install semihcihan/contextbrief/contextbrief
            ```

      - name: Update Homebrew tap cask
        if: ${{ env.HOMEBREW_TAP_REPO_TOKEN != '' && vars.HOMEBREW_TAP_REPO != '' }}
        env:
          TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
          TAP_REPO_TOKEN: ${{ env.HOMEBREW_TAP_REPO_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
          VERSION: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          git clone "https://x-access-token:${TAP_REPO_TOKEN}@github.com/${TAP_REPO}.git" tap
          mkdir -p tap/Casks
          cat > tap/Casks/contextbrief.rb <<EOF
          cask "contextbrief" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/semihcihan/contextbrief/releases/download/${TAG}/ContextBrief.dmg"
            name "Context Brief"
            desc "Local-first macOS menu bar app for collecting and densifying context"
            homepage "https://github.com/semihcihan/contextbrief"

            depends_on macos: ">= :ventura"

            app "ContextBrief.app"

            zap trash: [
              "~/Library/Application Support/ContextBrief",
              "~/Library/Preferences/com.semihcihan.contextgenerator.plist",
            ]
          end
          EOF
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/contextbrief.rb
          git commit -m "Update contextbrief to ${TAG}" || echo "No tap changes to commit"
          git push
